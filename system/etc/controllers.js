import*as e from"../lib/prediction.js";import a from"fs";export const event=function({CurrentFunction:e,logger:a,umaru:t}){let n=e.systemadmin;if((1!=e.event.isGroup||n.includes(e.event.senderID)||!t.data.hasOwnProperty("threads")||!t.data.threads.hasOwnProperty(e.event.threadID)||!t.data.threads[e.event.threadID].hasOwnProperty("isBanned"))&&(n.includes(e.event.senderID)||!t.data.hasOwnProperty("users")||!t.data.users.hasOwnProperty(e.event.senderID)||!t.data.users[e.event.senderID].hasOwnProperty("isBanned")))return e.args="message_unsend"!=e.event.type?e.event.body.trim().split(/\s+/):"",new Promise((async n=>{for(const n of t.client.umaruEvent){let r=t.umaruCommand.get(n);if(r.execEvent)try{r.execEvent(e).catch((e=>a.log("Error",n+": "+e.message)))}catch(e){a.log("Error",n+": "+e.message)}else if(r.handleEvent)try{r.handleEvent(e).catch((e=>a.log("Error",n+": "+e.message)))}catch(e){a.log("Error",n+": "+e.message)}}n(!0)}))};export const handleReply=function({CurrentFunction:e}){let{umaru:a}=e,t=e.systemadmin;if(1==e.event.isGroup&&!t.includes(e.event.senderID)&&a.data.hasOwnProperty("threads")&&a.data.threads.hasOwnProperty(e.event.threadID)&&a.data.threads[e.event.threadID].hasOwnProperty("isBanned"))return;if(!t.includes(e.event.senderID)&&a.data.hasOwnProperty("users")&&a.data.users.hasOwnProperty(e.event.senderID)&&a.data.users[e.event.senderID].hasOwnProperty("isBanned"))return;const{handleReply:n}=global.client,r=e.umaru.umaruCommand,{messageReply:s}=e.event;if(0!==n.length){const a=n.findIndex((e=>e.messageID==s.messageID));if(a<0)return;const t=n[a],d=r.get(t.name);if(!d)return;let o,i="default"==e.umaru.config.language?"en":e.umaru.config.language;return o=d.languages&&"object"==typeof d.languages&&d.languages.hasOwnProperty(i)?(...e)=>{if(!(d.languages||{}).hasOwnProperty(i))return;let a=d.languages[i][e[0]]||"";for(let t=e.length;t>0;t--){const n=RegExp("%"+t,"g");a=a.replace(n,e[t])}return a}:()=>{},e.getText=o,e.handleReply=t,void d.handleReply(e)}};export const execReply=function({CurrentFunction:e}){let{umaru:a}=e,t=e.systemadmin;if(1==e.event.isGroup&&!t.includes(e.event.senderID)&&a.data.hasOwnProperty("threads")&&a.data.threads.hasOwnProperty(e.event.threadID)&&a.data.threads[e.event.threadID].hasOwnProperty("isBanned"))return;if(!t.includes(e.event.senderID)&&a.data.hasOwnProperty("users")&&a.data.users.hasOwnProperty(e.event.senderID)&&a.data.users[e.event.senderID].hasOwnProperty("isBanned"))return;const n=a.execReply.data,r=e.umaru.umaruCommand,{messageReply:s}=e.event;if(0!==n.length){const a=n.findIndex((e=>e.ID==s.messageID));if(a<0)return;const t=n[a],d=r.get(t.name);if(!d)return;return e.execReply=t,void d.execReply(e)}};export const handleReaction=function({CurrentFunction:e}){let{umaru:a}=e,t=e.systemadmin;if(1==e.event.isGroup&&!t.includes(e.event.userID)&&a.data.hasOwnProperty("threads")&&a.data.threads.hasOwnProperty(e.event.threadID)&&a.data.threads[e.event.threadID].hasOwnProperty("isBanned"))return;if(!t.includes(e.event.userID)&&a.data.hasOwnProperty("users")&&a.data.users.hasOwnProperty(e.event.userID)&&a.data.users[e.event.userID].hasOwnProperty("isBanned"))return;const{handleReaction:n}=global.client,r=e.umaru.umaruCommand,{messageID:s}=e.event;if(0!==n.length){const a=n.findIndex((e=>e.messageID==s));if(a<0)return;const t=n[a],d=r.get(t.name);let o,i="default"==e.umaru.config.language?"en":e.umaru.config.language;if(!d)return;return o=d.languages&&"object"==typeof d.languages?(...e)=>{if(!(d.languages||{}).hasOwnProperty(i))return;let a=d.languages[i][e[0]]||"";for(let t=e.length;t>0;t--){const n=RegExp("%"+t,"g");a=a.replace(n,e[t])}return a}:()=>{},e.getText=o,e.handleReaction=t,void d.handleReaction(e)}};export const reaction=function({CurrentFunction:e,logger:a,id:t,usr:n,umaru:r}){let s=e.systemadmin;if((1!=e.event.isGroup||s.includes(e.event.senderID)||!r.data.hasOwnProperty("threads")||!r.data.threads.hasOwnProperty(e.event.threadID)||!r.data.threads[e.event.threadID].hasOwnProperty("isBanned"))&&(s.includes(e.event.senderID)||!r.data.hasOwnProperty("users")||!r.data.users.hasOwnProperty(e.event.senderID)||!r.data.users[e.event.senderID].hasOwnProperty("isBanned")))return new Promise((async s=>{for(const s of r.client.umaruReact)if(r.process.react[t]&&r.process.react[t][n]&&1==r.process.react[t][n][s]){delete r.process.react[t];try{r.umaruCommand.get(s).execReact(e).catch((e=>a.log("Error",s+": "+e.message)))}catch(e){a.log("Error",s+": "+e.message)}}s(!0)}))};export const reply=function({CurrentFunction:e,logger:t,event:n,v8:r}){const s=function(e){return new Promise(((t,n)=>{try{let r=a.createReadStream(e),s=[];r.on("data",(e=>{s.push(e)})),r.on("end",(async()=>{t(Buffer.concat(s))})),r.on("error",(e=>{n(e)}))}catch(e){n(e)}}))};let{umaru:d}=e,o=e.systemadmin;if((1!=e.event.isGroup||o.includes(e.event.senderID)||!d.data.hasOwnProperty("threads")||!d.data.threads.hasOwnProperty(e.event.threadID)||!d.data.threads[e.event.threadID].hasOwnProperty("isBanned"))&&(o.includes(e.event.senderID)||!d.data.hasOwnProperty("users")||!d.data.users.hasOwnProperty(e.event.senderID)||!d.data.users[e.event.senderID].hasOwnProperty("isBanned")))return e.args=e.event.body.trim().split(/\s+/),new Promise((async o=>{let i;for(const l of d.client.umaruReply)try{let t=d.client.user+"/uid_"+n.threadID+"/"+l+".log",c=d.client.user+"/uid_"+n.senderID+"/"+l+".log",u=d.client.user+"/uid_global/"+l+"_"+n.messageReply.messageID+".log";try{i=a.existsSync(t)?r.deserialize(await s(t)):a.existsSync(c)?r.deserialize(await s(c)):a.existsSync(u)?r.deserialize(await s(u)):{}}catch{i={}}if(n.messageReply.messageID===i.ID){d.umaruCommand.get(l).execReply(e).catch((e=>{console.log(e)})),o(!0);break}}catch(e){t.log("Error",l+": "+e.message),o(!0);break}o(!0)}))};export const events=function({CurrentFunction:e,logger:a,umaru:t}){return new Promise((async n=>{for(const n of t.client.umaruEvents){if(e.event.logMessageType&&!t.client.setEvent.get(n).includes(e.event.logMessageType)||["change_thread_image"].includes(e.event.type)&&!t.client.setEvent.get(n).includes(e.event.type))continue;let r=t.umaruEvents.get(n);if(r.exec)try{r.exec(e).catch((e=>a.log("Error",n+": "+e.message)))}catch(e){a.log("Error",n+": "+e.message)}else if(r.run)try{e.args=args,r.run(e).catch((e=>a.log("Error",n+": "+e.message)))}catch(e){a.log("Error",n+": "+e.message)}}n(!0)}))};export const command=async function({CurrentFunction:t,logger:n,args:r,deleteJournal:s,Umaru:d,event:o,key:i,setData:l,moment:c,getAdminIDs:u,umaru:g,isConsole:m,translate:h,prefix:p}){let f={},D=o.body.toLowerCase().split(/\s+/)[0];if(o.body[0]==p&&" "==o.body[1])f=e.predict(r[1].toLowerCase(),g.client.allCommandsName),r.shift(),r.shift();else if(0!=m&&""!=p||!g.client.allCommandsName.includes(D.replace(p,""))&&!g.client.noPrefix.includes(D.replace(p,""))){if(0==m||""==p)return;f=e.predict(D.replace(p,""),g.client.allCommandsName),r.shift()}else f.data=D.replace(p,""),f.accuracy=1,r.shift();let y=!1;function I(e){let t=[".jpg",".jpeg",".png"],n=a.readdirSync(g.mainPath+"/media/bantemplate/enable/random").filter((e=>t.some((a=>!e.endsWith(".mp4.jpg")&&e.endsWith(a))))),r=n[Math.floor(Math.random()*n.length)],s=g.mainPath+"/media/bantemplate/enable/random/"+r,i=g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg",l=a.existsSync(i);return 1==l&&(s=i),void 0!==r||l?d.sendMessage({body:e,attachment:a.createReadStream(s)},o.threadID,(e=>{e&&P()}),o.messageID):P()}function w(e){let t=[".mp4",".mov",".avi",".flv",".wmv",".mkv",".m4v",".mpg",".mpeg",".3gp",".webm"],n=a.readdirSync(g.mainPath+"/media/bantemplate/enable/random").filter((e=>t.some((a=>e.endsWith(a))))),r=n[Math.floor(Math.random()*n.length)],s=g.mainPath+"/media/bantemplate/enable/random/"+r,i=g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg",l=a.existsSync(i);return 1==l&&(s=i),void 0!==r||l?d.sendMessage({body:e,attachment:a.createReadStream(s)},o.threadID,(e=>{e&&P()}),o.messageID):P()}function v(e){let t=[".gif"],n=a.readdirSync(g.mainPath+"/media/bantemplate/enable/random").filter((e=>t.some((a=>e.endsWith(a))))),r=n[Math.floor(Math.random()*n.length)],s=g.mainPath+"/media/bantemplate/enable/random/"+r,i=g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg",l=a.existsSync(i);return 1==l&&(s=i),void 0!==r||l?d.sendMessage({body:e,attachment:a.createReadStream(s)},o.threadID,(e=>{e&&P()}),o.messageID):P()}function P(e){let t=g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg",n="",r=a.existsSync(t);return 1==r&&(n=t),"undefined"!=typeof filePath||r?d.sendMessage({body:e,attachment:a.createReadStream(n)},o.threadID,(a=>{if(a)return d.sendMessage({body:e},o.messageID)}),o.messageID):d.sendMessage({body:e},o.threadID,o.messageID)}function b(e){let t=[".mp4",".mov",".avi",".flv",".wmv",".mkv",".m4v",".mpg",".mpeg",".3gp",".webm",".jpg",".jpeg",".png",".gif"],n=a.readdirSync(g.mainPath+"/media/bantemplate/enable/random").filter((e=>t.some((a=>!e.endsWith(".mp4.jpg")&&e.endsWith(a))))),r=n[Math.floor(Math.random()*n.length)],s=g.mainPath+"/media/bantemplate/enable/random/"+r,i=g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg",l=a.existsSync(i);return 1==l&&(s=i),void 0!==r||l?d.sendMessage({body:e,attachment:a.createReadStream(s)},o.threadID,(e=>{e&&P()}),o.messageID):P()}a.existsSync(g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg")&&g.data.hasOwnProperty("users")&&g.data.users.hasOwnProperty(o.senderID)&&!g.data.users[o.senderID].hasOwnProperty("isBanned")&&a.unlinkSync(g.systemPath+"/data/Users/"+o.senderID+"/ban.jpg");let O=t.systemadmin;if(1==o.isGroup&&O.includes(o.threadID)&&(O=o.participantIDs),1==o.isGroup&&!O.includes(o.senderID)&&g.data.threads.hasOwnProperty(o.threadID)&&g.data.threads[o.threadID].hasOwnProperty("isBanned")){if(!g.process.banTimer[o.threadID]||Date.now()-g.process.banTimer[o.threadID]>12e5){g.process.banTimer[o.threadID]=Date.now();let U=g.config.Addons.isBanned.thread.replace("{reason}",g.data.threads[o.threadID].isBanned);switch(g.config.BanTemplate){case"canvas":getCanvas(U);break;case"image":I(U);break;case"gif":v(U);break;case"none":P(U);break;case"video":w(U);break;case"random":b(U)}}y=!0}else if(!O.includes(o.senderID)&&g.data.users.hasOwnProperty(o.senderID)&&g.data.users[o.senderID].hasOwnProperty("isBanned")){if(!g.process.banTimer[o.senderID]||Date.now()-g.process.banTimer[o.senderID]>12e5){g.process.banTimer[o.senderID]=Date.now();let C=g.config.Addons.isBanned.user.replace("{reason}",g.data.users[o.senderID].isBanned);switch(g.config.BanTemplate){case"canvas":getCanvas(C);break;case"image":I(C);break;case"gif":v(C);break;case"none":P(C);break;case"video":w(C);break;case"random":b(C)}}y=!0}try{if(0==g.data.threads[o.threadID].active){if("onbot"==f.data){let E=g.umaruCommand.get(f.data);if(1==y)return;if(E.execCommand)try{t.args=r,E.execCommand(t).catch((e=>{s(o),n.log("Error",f.data+": "+e.message)}))}catch(R){s(o),n.log("Error",f.data+": "+R.message)}else if(E.run)try{t.args=r,E.run(t).catch((e=>{s(o),n.log("Error",f.data+": "+e.message)}))}catch(B){s(o),n.log("Error",f.data+": "+B.message)}}return}}catch{try{if(0==g.data.users[o.threadID].active){if("onbot"==f.data){let M=g.umaruCommand.get(f.data);if(1==y)return;if(M.execCommand)try{t.args=r,M.execCommand(t).catch((e=>{s(o),n.log("Error",f.data+": "+e.message)}))}catch(j){s(o),n.log("Error",f.data+": "+j.message)}else if(M.run)try{t.args=r,M.run(t).catch((e=>{s(o),n.log("Error",f.data+": "+e.message)}))}catch(k){s(o),n.log("Error",f.data+": "+k.message)}}return}}catch{}}if(!(f.accuracy>=.5)){if(0==m)return;if(""==p)return;if(1==y)return;let S,_=o.body.trim().split(/\s+/),T='"'+_[0].replace(p,"")+'"';const G=await import("./lang.js");return S=await G.getClient({event:o,key:i,Umaru:d,setData:l,moment:c,similarity:f,found:T,command:_,umaru:g,translate:h,prefix:p}),d.sendMessage(S,o.threadID,o.messageID)}{if((!1===o.isGroup&&!O.includes(o.senderID)||1==o.isGroup&&g.data.threads[o.threadID]&&1!=g.data.threads[o.threadID].nsfw)&&!t.cooldown.isCooldown(o.senderID+"_nsfw",600)&&"nsfw"==g.category.get(f.data).toLowerCase()&&!O.includes(o.senderID))return t.cooldown.create(o.senderID+"_nsfw"),d.sendMessage(await h(g.config.nsfw_msg,o,null,!0),o.threadID,o.messageID);if("nsfw"==g.category.get(f.data).toLowerCase()&&t.cooldown.isCooldown(o.senderID+"_nsfw",600))return;if(!O.includes(o.senderID)&&2===g.client.permission.get(f.data)){if(1==y)return;return d.sendMessage((await h(g.config.permission_2,o,null,!0)).replace("{{1}}",g.name.get(f.data)),o.threadID,o.messageID)}function x(){if(1==y)return;let e,a=g.umaruCommand.get(f.data),d="default"==g.config.language?"en":g.config.language;if(e=a.languages&&"object"==typeof a.languages&&a.languages.hasOwnProperty(d)?(...e)=>{let t=a.languages[d][e[0]]||"";for(let a=e.length;a>0;a--){const n=RegExp("%"+a,"g");t=t.replace(n,e[a])}return t}:()=>{},t.getText=e,a.execCommand)try{t.args=r,a.execCommand(t).catch((e=>{console.log(e),s(o),n.log("Error",f.data+": "+e.message)}))}catch(e){console.log(e),s(o),n.log("Error",f.data+": "+e.message)}else if(a.run)try{t.args=r,a.run(t).catch((e=>{s(o),console.log(e),n.log("Error",f.data+": "+e.message)}))}catch(e){s(o),console.log(e),n.log("Error",f.data+": "+e.message)}}try{if(!(await u(o.threadID)).includes(o.senderID)){if(O.includes(o.senderID)){if(g.client.lastUsage[o.senderID]||(g.client.lastUsage[o.senderID]={}),!g.client.lastUsage[o.senderID][f.data]||Date.now()-g.client.lastUsage[o.senderID][f.data]>1e3*g.client.cooldown.get(f.data))x(),O.includes(o.senderID)||(g.client.lastUsage[o.senderID][f.data]=Date.now());else{if(1==y)return;let F=f.data+"-cooldown";if(!g.client.lastUsage[o.senderID][F]||Date.now()-g.client.lastUsage[o.senderID][F]>1e3*g.client.cooldown.get(f.data))return O.includes(o.senderID)||(g.client.lastUsage[o.senderID][F]=Date.now()),(await import("./Users.js")).cooldown({event:o,key:i,Umaru:d,similarity:f,umaru:g,translate:h})}return}if(1===g.client.permission.get(f.data)){if(1==y)return;return d.sendMessage((await h(g.config.permission_1,o,null,!0)).replace("{{1}}",g.name.get(f.data)),o.threadID,o.messageID)}}}catch{if(O.includes(o.senderID)){if(g.client.lastUsage[o.senderID]||(g.client.lastUsage[o.senderID]={}),!g.client.lastUsage[o.senderID][f.data]||Date.now()-g.client.lastUsage[o.senderID][f.data]>1e3*g.client.cooldown.get(f.data))x(),O.includes(o.senderID)||(g.client.lastUsage[o.senderID][f.data]=Date.now());else{if(1==y)return;let W=f.data+"-cooldown";if(!g.client.lastUsage[o.senderID][W]||Date.now()-g.client.lastUsage[o.senderID][W]>1e3*g.client.cooldown.get(f.data))return O.includes(o.senderID)||(g.client.lastUsage[o.senderID][W]=Date.now()),(await import("./Users.js")).cooldown({event:o,key:i,Umaru:d,similarity:f,umaru:g,translate:h})}return}if(1===g.client.permission.get(f.data)){if(1==y)return;return d.sendMessage((await h(g.config.permission_1,o,null,!0)).replace("{{1}}",g.name.get(f.data)),o.threadID,o.messageID)}}if(g.client.lastUsage[o.senderID]||(g.client.lastUsage[o.senderID]={}),!g.client.lastUsage[o.senderID][f.data]||Date.now()-g.client.lastUsage[o.senderID][f.data]>1e3*g.client.cooldown.get(f.data))x(),O.includes(o.senderID)||(g.client.lastUsage[o.senderID][f.data]=Date.now());else{if(1==y)return;let L=f.data+"-cooldown";if(!g.client.lastUsage[o.senderID][L]||Date.now()-g.client.lastUsage[o.senderID][L]>1e3*g.client.cooldown.get(f.data))return O.includes(o.senderID)||(g.client.lastUsage[o.senderID][L]=Date.now()),(await import("./Users.js")).cooldown({event:o,key:i,Umaru:d,similarity:f,umaru:g,translate:h})}}};